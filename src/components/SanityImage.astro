---
import imageUrlBuilder from '@sanity/image-url'
import { sanityClient } from '../lib/sanity'

interface Props {
  image: { asset: { _ref: string }; hotspot?: { x: number; y: number } }
  alt?: string
  class?: string
  width?: number
  height?: number
}

const { image, alt = '', class: className = '', width = 800, height } = Astro.props

const builder = imageUrlBuilder(sanityClient)

// Parse original dimensions from asset ref: image-{hash}-{width}x{height}-{format}
const refParts = image.asset._ref.split('-')
const [origW, origH] = refParts[2]?.split('x').map(Number) || [800, 600]
const aspectRatio = origW / origH
const finalHeight = height || Math.round(width / aspectRatio)

const imgUrl = builder
  .image(image)
  .auto('format')
  .fit('crop')
  .width(width)
  .height(finalHeight)
  .url()
---

{image?.asset && (
  <img src={imgUrl} alt={alt} width={width} height={finalHeight} loading="lazy" class={className} />
)}
